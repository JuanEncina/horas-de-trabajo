<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Registro de Horarios</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6750A4">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#6750A4;
  --surface:#FFFFFF;
  --bg:#F4EFF4;
  --danger:#B3261E;
}

body{
  font-family: system-ui, -apple-system, Roboto, sans-serif;
  background:var(--bg);
  margin:0;
  padding:16px;
}

.app{
  max-width:420px;
  margin:auto;
}

h1{
  text-align:center;
  color:var(--primary);
  margin-bottom:16px;
}

.card{
  background:var(--surface);
  border-radius:16px;
  padding:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
  margin-bottom:16px;
}

label{
  font-size:14px;
  color:#555;
}

input{
  width:100%;
  padding:10px;
  font-size:16px;
  margin-top:4px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  width:100%;
  padding:12px;
  font-size:16px;
  border:none;
  border-radius:24px;
  cursor:pointer;
}

.btn-primary{
  background:var(--primary);
  color:white;
}

.btn-secondary{
  background:#444;
  color:white;
  margin-top:8px;
}

.registro{
  font-size:14px;
  padding:8px 0;
  border-bottom:1px solid #eee;
}

.registro button{
  width:auto;
  font-size:12px;
  padding:6px 10px;
  margin-right:4px;
}

.borrar{
  background:var(--danger);
  color:white;
}
</style>
</head>

<body>

<div class="app">
<h1>Registro de Horarios</h1>

<div class="card">
<label>Fecha</label>
<input type="date" id="fecha">

<label>Ingreso</label>
<input type="time" id="entrada">

<label>Egreso</label>
<input type="time" id="salida">

<button class="btn-primary" onclick="guardar()">Guardar</button>
<button class="btn-secondary" onclick="generarReporte()">Generar Excel</button>
</div>

<div class="card" id="lista"></div>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/registro-horarios/sw.js', {
    scope: '/registro-horarios/'
  });
}

let registros = JSON.parse(localStorage.getItem('registros') || '[]');
const lista = document.getElementById('lista');

render();

function guardar(){
  const f=fecha.value, e=entrada.value, s=salida.value;
  if(!f||!e||!s) return alert('Complete todos los campos');

  registros.push({fecha:f, entrada:e, salida:s, duracion:duracion(e,s)});
  localStorage.setItem('registros', JSON.stringify(registros));
  render();
}

function editar(i){
  const r=registros[i];
  const f=prompt('Fecha',r.fecha);
  const e=prompt('Ingreso',r.entrada);
  const s=prompt('Egreso',r.salida);
  if(!f||!e||!s) return;
  registros[i]={fecha:f,entrada:e,salida:s,duracion:duracion(e,s)};
  localStorage.setItem('registros', JSON.stringify(registros));
  render();
}

function borrar(i){
  if(!confirm('Eliminar registro?')) return;
  registros.splice(i,1);
  localStorage.setItem('registros', JSON.stringify(registros));
  render();
}

function render(){
  lista.innerHTML='<b>Registros</b>';
  registros.forEach((r,i)=>{
    lista.innerHTML+=`
    <div class="registro">
      ${r.fecha} | ${r.entrada} - ${r.salida} â†’ ${r.duracion}<br>
      <button onclick="editar(${i})">Editar</button>
      <button class="borrar" onclick="borrar(${i})">Borrar</button>
    </div>`;
  });
}

function duracion(e,s){
  const [h1,m1]=e.split(':').map(Number);
  const [h2,m2]=s.split(':').map(Number);
  let a=h1*60+m1, b=h2*60+m2;
  if(b<a) b+=1440;
  const d=b-a;
  return String(Math.floor(d/60)).padStart(2,'0')+':'+String(d%60).padStart(2,'0');
}

function generarReporte(){
  if(registros.length===0) return alert('No hay datos');

  const wb=XLSX.utils.book_new();

  /* ðŸ”¹ NUEVA HOJA: DETALLE POR REGISTRO */
  const detalle=[['Fecha','Ingreso','Egreso','Total']];
  registros.forEach(r=>{
    detalle.push([r.fecha,r.entrada,r.salida,r.duracion]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(detalle),'Detalle por registro');

  /* ðŸ”¹ DETALLE DIARIO */
  const diario={};
  registros.forEach(r=>{
    const [h,m]=r.duracion.split(':').map(Number);
    diario[r.fecha]=(diario[r.fecha]||0)+(h*60+m);
  });
  const shDia=[['Fecha','Total del dÃ­a']];
  Object.keys(diario).sort().forEach(f=>{
    shDia.push([f,hhmm(diario[f])]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(shDia),'Detalle diario');

  XLSX.writeFile(wb,'reporte_horarios.xlsx');
}

function hhmm(min){
  return String(Math.floor(min/60)).padStart(2,'0')+':'+String(min%60).padStart(2,'0');
}
</script>

</body>
</html>
